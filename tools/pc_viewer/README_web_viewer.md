# ESP32 WiFi摄像头Web显示程序使用说明

## 功能介绍

`web_camera_viewer.py` 是一个基于Flask的Web应用程序，可以在浏览器中实时显示ESP32摄像头拍摄的画面。程序使用MJPEG流技术，提供流畅的实时视频体验。

## 主要特性

- **Web界面显示**: 通过浏览器访问摄像头画面，无需安装额外软件
- **实时MJPEG流**: 使用标准的MJPEG流协议，兼容性好
- **响应式设计**: 支持不同设备和屏幕尺寸
- **连接状态显示**: 实时显示摄像头连接状态
- **自动重连**: TCP连接断开后自动尝试重连

## 安装依赖

在运行程序前，需要安装所需的Python库：

```bash
# 方法1：使用requirements.txt安装
pip install -r requirements.txt

# 方法2：手动安装各个依赖
pip install flask>=2.0.0
pip install opencv-python>=4.5.0
pip install numpy>=1.20.0
```

## 使用方法

### 1. 启动Web服务器

```bash
# 基本用法（使用默认端口）
python web_camera_viewer.py

# 指定端口
python web_camera_viewer.py --port 8000 --web-port 5000

# 指定监听地址
python web_camera_viewer.py --host 0.0.0.0 --port 8000 --web-port 5000
```

### 2. 参数说明

- `--host`: TCP监听地址，默认 `0.0.0.0`（监听所有网卡）
- `--port`: TCP监听端口，默认 `8000`（需与ESP32固件配置一致）
- `--web-port`: Web服务端口，默认 `5000`
- `--timeout`: 等待ESP32连接超时时间，默认 `10.0` 秒

### 3. 访问Web界面

程序启动后，会显示访问地址：

```
请在浏览器中访问:
  本机访问: http://localhost:5000
  局域网访问: http://192.168.1.100:5000
```

在浏览器中打开相应地址即可查看摄像头画面。

## ESP32固件配置

确保ESP32固件中的网络配置正确：

1. **WiFi连接**: ESP32需要连接到与PC相同的WiFi网络
2. **服务器IP**: 在ESP32代码中设置正确的服务器IP地址（运行此程序的PC的IP）
3. **端口号**: ESP32发送数据的目标端口需要与本程序的 `--port` 参数一致

## 故障排除

### 1. 无法启动Web服务器

- **端口被占用**: 尝试更换 `--web-port` 参数
- **权限问题**: 在Windows上可能需要以管理员身份运行
- **防火墙**: 确保防火墙允许程序监听端口

### 2. ESP32无法连接

- **网络连通性**: 确保ESP32和PC在同一网络
- **IP地址**: 检查ESP32代码中的服务器IP地址是否正确
- **端口号**: 确认ESP32发送数据的端口与程序监听端口一致
- **防火墙**: 确保防火墙允许TCP连接

### 3. 画面卡顿或延迟

- **网络带宽**: 检查WiFi网络质量
- **图像质量**: 在ESP32端适当降低图像质量或分辨率
- **缓冲区**: 程序会自动丢弃过旧的帧以减少延迟

### 4. 浏览器显示问题

- **兼容性**: 推荐使用Chrome、Firefox或Edge等现代浏览器
- **缓存**: 尝试刷新页面或清除浏览器缓存
- **网络**: 确保浏览器能正常访问Web服务器

## 程序架构

### 主要组件

1. **TCP服务器线程**: 监听ESP32连接，接收JPEG图像数据
2. **图像处理队列**: 缓存最新的图像帧，避免内存溢出
3. **Flask Web服务器**: 提供HTTP服务和MJPEG流
4. **HTML界面**: 响应式Web界面，显示摄像头画面和状态

### 数据流程

```
ESP32摄像头 → WiFi → TCP连接 → 图像队列 → MJPEG流 → 浏览器显示
```

## 性能优化建议

1. **调整队列大小**: 根据网络环境调整 `frame_queue` 的 `maxsize`
2. **图像压缩**: 在ESP32端适当调整JPEG质量参数
3. **网络优化**: 使用5GHz WiFi或有线网络以获得更好性能
4. **资源监控**: 监控CPU和内存使用情况，必要时调整参数

## 开发扩展

程序提供了良好的扩展性，可以添加以下功能：

- 图像录制和保存
- 多摄像头支持
- 用户认证和访问控制
- 移动端适配优化
- WebRTC实时通信
- 图像处理和分析功能

## 许可证

本程序基于原始的 `viewer.py` 开发，遵循相同的许可证条款。